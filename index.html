<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMDR Qazaqstan</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root{
    --bg:#fbfcfe; --card:#ffffff; --accent-1:#173e9b; --accent-2:#6fa8ff; --text:#0f1724;
    --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:-apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial;}
  #appOverlay{position:fixed;inset:0;display:flex;flex-direction:column;}
  .app-header{height:60px;padding-top:var(--safe-top);padding-left:12px;padding-right:12px;display:flex;align-items:center;gap:12px;background:linear-gradient(90deg,var(--accent-1), #2f6bff);color:#fff;}
  .app-title{font-weight:800;font-size:16px;flex:1;text-transform:uppercase;}
  .app-close{background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;border:0}
  .app-body{flex:1;overflow:auto;padding:18px;padding-bottom:calc(22px + var(--safe-bottom));}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 4px 16px rgba(0,0,0,0.05);margin-bottom:14px}
  h2{margin:0 0 6px;font-size:18px}
  .small{margin:0 0 12px;color:#475569;font-size:14px}
  .row{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
  label{min-width:90px;font-weight:700;font-size:14px;color:var(--text);}
  .range-wrap{flex:1;display:flex;align-items:center;gap:10px;}
  input[type=range]{-webkit-appearance:none;width:100%;height:28px;background:transparent;}
  input[type=range]::-webkit-slider-runnable-track{height:8px;border-radius:999px;background:#e6f0ff}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:var(--accent-2);box-shadow:0 4px 14px rgba(47,107,255,0.25);margin-top:-7px}
  .value{width:46px;text-align:center;font-weight:800;}
  .controls{display:flex;gap:10px;margin-top:6px;}
  .btn{flex:1;padding:12px;border-radius:12px;border:0;font-weight:800;color:#fff;font-size:16px;cursor:pointer;}
  .btn.start{background:var(--accent-1);}
  .btn.pause{background:#f6a54a;}
  .btn.stop{background:#ff5a5a;}
  #play-area{position:relative;height:280px;margin-top:12px;background:#fff;border-radius:12px;overflow:hidden;border:1px solid #dde7ff;}
  #emdr-ball{position:absolute;top:50%;transform:translateY(-50%);display:none;border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #9bbaff 0%, var(--accent-2) 45%, var(--accent-1) 100%);
    box-shadow:0 12px 28px rgba(31,76,189,0.25), inset 0 -8px 18px rgba(0,0,0,0.15);
  }
  .counter{margin-top:10px;font-weight:800;color:var(--text);}

  /* DIALOG */
  .dialog-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;}
  .dialog{background:#fff;padding:16px;border-radius:12px;max-width:90%;}
  textarea{width:100%;min-height:80px;border:1px solid #ccc;border-radius:8px;padding:8px;}
  .send-btn{background:var(--accent-1);color:#fff;margin-top:8px;padding:10px;border-radius:8px;border:0;font-weight:700;width:100%;cursor:pointer;}
</style>
</head>

<body>
<div id="appOverlay">
  <div class="app-header">
    <div class="app-title">EMDR Qazaqstan</div>
    <button id="closeApp" class="app-close">Закрыть</button>
  </div>

  <div class="app-body">
    <div class="card">
      <h2>EMDR — мини-сессия</h2>
      <p class="small">Выставь параметры → нажми <b>Старт</b>.</p>

      <div class="row">
        <label>Скорость</label>
        <div class="range-wrap">
          <input id="speedRange" type="range" min="1" max="20" value="10">
          <div id="speedVal" class="value">10</div>
        </div>
      </div>

      <div class="row">
        <label>Размер</label>
        <div class="range-wrap">
          <input id="sizeRange" type="range" min="1" max="5" value="3">
          <div id="sizeVal" class="value">3</div>
        </div>
      </div>

      <div class="row">
        <label>Сеты</label>
        <div class="range-wrap">
          <input id="setsRange" type="range" min="1" max="30" value="10">
          <div id="setsVal" class="value">10</div>
        </div>
      </div>

      <div class="controls">
        <button id="startBtn" class="btn start">Старт</button>
        <button id="pauseBtn" class="btn pause" style="display:none;">Пауза</button>
        <button id="stopBtn" class="btn stop" style="display:none;">Стоп</button>
      </div>

      <div id="set-counter" class="counter"></div>
    </div>

    <div id="play-area" class="card">
      <div id="emdr-ball"></div>
    </div>
  </div>
</div>

<script>
let tg=false;try{tg=window.Telegram.WebApp;tg.expand();}catch(e){}
const speedRange = speedRange;
const sizeRange  = sizeRange;
const setsRange  = setsRange;

speedRange.oninput = ()=> speedVal.innerText = speedRange.value;
sizeRange.oninput  = ()=> sizeVal.innerText  = sizeRange.value;
setsRange.oninput  = ()=> setsVal.innerText  = setsRange.value;

let animationId=null, vx=0, posX=0, direction=1, setsLeft=0, paused=false, dialogShown=false;
const ball = document.getElementById("emdr-ball");
const playArea = document.getElementById("play-area");

function recalc(){
  const ballSize = Number(sizeRange.value)*18+10;
  ball.style.width = ballSize+"px";
  ball.style.height = ballSize+"px";
  fullWidth = playArea.clientWidth - ballSize;
}
window.onresize = recalc;

function start(){
  posX=0;
  direction=1;
  setsLeft = Number(setsRange.value);
  vx = Number(speedRange.value) * 0.6;
  paused=false;
  dialogShown=false;

  recalc();

  startBtn.style.display="none";
  pauseBtn.style.display="inline-block";
  stopBtn.style.display="inline-block";

  ball.style.display="block";
  animate();
}

function animate(){
  if(!paused){
    posX += vx * direction;
    if(posX>=fullWidth){direction=-1; posX=fullWidth; playSound();}
    if(posX<=0){
      direction=1; posX=0; playSound();
      setsLeft--;
      document.getElementById("set-counter").innerHTML="Осталось сетов: <b>"+setsLeft+"</b>";

      if(setsLeft<=0){ endNatural(); return; }
    }
    ball.style.left = posX+"px";
  }
  animationId=requestAnimationFrame(animate);
}

function playSound(){
  try{
    const ctx=new AudioContext();
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.type="triangle";
    osc.frequency.value=300;
    osc.connect(gain);
    gain.connect(ctx.destination);
    gain.gain.setValueAtTime(0.2, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.25);
    osc.start(); osc.stop(ctx.currentTime+0.25);
  }catch(e){}
}

function pauseToggle(){
  paused=!paused;
  pauseBtn.innerText = paused ? "Продолжить" : "Пауза";

  if(paused && !dialogShown){
    dialogShown=true;
    showDialog();
  }
}

function stop(){
  if(animationId) cancelAnimationFrame(animationId);
  ball.style.display="none";

  startBtn.style.display="inline-block";
  pauseBtn.style.display="none";
  stopBtn.style.display="none";

  if(!dialogShown){
    dialogShown=true;
    showDialog();
  }
}

function endNatural(){
  if(animationId) cancelAnimationFrame(animationId);
  ball.style.display="none";
  startBtn.style.display="inline-block";
  pauseBtn.style.display="none";
  stopBtn.style.display="none";

  if(!dialogShown){
    dialogShown=true;
    showDialog(true);
  }
}

function showDialog(isFinal=false){
  const overlay=document.createElement("div");
  overlay.className="dialog-overlay";

  overlay.innerHTML=`
    <div class="dialog">
      <p id="dlg-text">Что удалось заметить?</p>
      <div id="dlg-input" style="display:none;">
        <textarea id="dlg-area"></textarea>
        <button class="send-btn" id="dlg-send">Отправить</button>
      </div>
    </div>
  `;

  playArea.appendChild(overlay);

  setTimeout(()=>{
    document.getElementById("dlg-text").style.display="none";
    document.getElementById("dlg-input").style.display="block";
  },2000);

  document.getElementById("dlg-send").onclick=()=>{
    document.getElementById("dlg-input").style.display="none";
    document.getElementById("dlg-text").innerText="Хорошо. Заметь это";
    document.getElementById("dlg-text").style.display="block";

    setTimeout(()=>{
      overlay.remove();
    },2000);
  };
}

startBtn.onclick = start;
pauseBtn.onclick = pauseToggle;
stopBtn.onclick = stop;
</script>

</body>
</html>
